---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

// Get all blog posts for navigation
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get the current post
export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { entry: post },
  }));
}

const { entry } = Astro.props;
const { Content, remarkPluginFrontmatter } = await render(entry);

// Find previous and next posts
const currentIndex = sortedPosts.findIndex(p => p.id === entry.id);
const previousPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

// Calculate reading time (rough estimate: 200 words per minute)
const wordsPerMinute = 200;
const text = entry.body;
const wordCount = text.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / wordsPerMinute);

// Format date
const formattedDate = entry.data.pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
>

  <!-- Article Header -->
  <article class="py-12 md:py-20">
    <div class="container max-w-4xl">

      <!-- Breadcrumbs -->
      <nav class="text-sm text-slate mb-8">
        <a href="/" class="hover:text-carolina transition-colors">Home</a>
        <span class="mx-2">/</span>
        <a href="/blog" class="hover:text-carolina transition-colors">Insights</a>
        <span class="mx-2">/</span>
        <span class="text-charcoal">{entry.data.title}</span>
      </nav>

      <!-- Article Metadata -->
      <header class="mb-12">
        {entry.data.tags.length > 0 && (
          <div class="flex gap-2 mb-4">
            {entry.data.tags.map((tag) => (
              <a
                href={`/blog/tag/${tag}`}
                class="text-xs px-3 py-1 rounded-full bg-carolina-pale text-carolina-dark hover:bg-carolina hover:text-white transition-colors"
              >
                {tag}
              </a>
            ))}
          </div>
        )}

        <h1 class="text-4xl md:text-5xl font-display text-navy mb-6 leading-tight">
          {entry.data.title}
        </h1>

        <p class="text-xl text-slate leading-relaxed mb-6">
          {entry.data.description}
        </p>

        <div class="flex flex-wrap items-center gap-4 text-sm text-slate border-t border-b border-stone py-4">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-carolina" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="font-medium text-charcoal">{entry.data.author}</span>
          </div>
          <span class="text-stone">•</span>
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-carolina" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <time datetime={entry.data.pubDate.toISOString()}>
              {formattedDate}
            </time>
          </div>
          <span class="text-stone">•</span>
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-carolina" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>{readingTime} min read</span>
          </div>
        </div>
      </header>

      <!-- Article Content with Prose Styling -->
      <div class="prose prose-lg prose-slate max-w-none mb-16">
        <Content />
      </div>

      <!-- Substack Cross-Post Link -->
      {entry.data.substackUrl && (
        <div class="bg-cream border border-stone rounded-lg p-6 mb-16">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-10 h-10 bg-carolina rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-navy mb-2">Read on Substack</h3>
              <p class="text-sm text-slate mb-3">
                This post is also available on our Substack newsletter, where you can subscribe for updates.
              </p>
              <a
                href={entry.data.substackUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm font-medium text-carolina hover:text-carolina-dark transition-colors inline-flex items-center gap-1"
              >
                View on Substack
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
              </a>
            </div>
          </div>
        </div>
      )}

      <!-- Tags (Repeated at Bottom) -->
      {entry.data.tags.length > 0 && (
        <div class="mb-16">
          <h3 class="text-sm font-semibold text-navy uppercase tracking-wide mb-3">Topics</h3>
          <div class="flex flex-wrap gap-2">
            {entry.data.tags.map((tag) => (
              <a
                href={`/blog/tag/${tag}`}
                class="text-xs px-3 py-1 rounded-full bg-carolina-pale text-carolina-dark hover:bg-carolina hover:text-white transition-colors"
              >
                {tag}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Previous / Next Navigation -->
      <nav class="border-t border-stone pt-8 mb-16">
        <div class="grid md:grid-cols-2 gap-8">
          {previousPost && (
            <a
              href={`/blog/${previousPost.id}`}
              class="group flex flex-col"
            >
              <span class="text-xs text-slate uppercase tracking-wide mb-2">Previous Post</span>
              <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-carolina group-hover:translate-x-[-4px] transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                <span class="text-lg font-display text-navy group-hover:text-carolina transition-colors">
                  {previousPost.data.title}
                </span>
              </div>
            </a>
          )}

          {nextPost && (
            <a
              href={`/blog/${nextPost.id}`}
              class="group flex flex-col md:items-end md:text-right"
            >
              <span class="text-xs text-slate uppercase tracking-wide mb-2">Next Post</span>
              <div class="flex items-center gap-3">
                <span class="text-lg font-display text-navy group-hover:text-carolina transition-colors">
                  {nextPost.data.title}
                </span>
                <svg class="w-5 h-5 text-carolina group-hover:translate-x-[4px] transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </a>
          )}
        </div>
      </nav>

    </div>
  </article>

  <!-- Newsletter CTA -->
  <section class="py-16 bg-navy">
    <div class="container max-w-4xl">
      <div class="text-center">
        <h2 class="text-3xl font-display text-white mb-4">Stay Updated</h2>
        <p class="text-lg text-white/70 mb-8 max-w-2xl mx-auto">
          Subscribe to our newsletter for monthly research updates, policy analysis, and digital health insights.
        </p>
        <a href="/newsletter" class="btn-primary bg-carolina inline-flex">
          Subscribe to Newsletter
        </a>
      </div>
    </div>
  </section>

</BaseLayout>

<style>
  /* Prose Styling for Blog Content */
  .prose {
    /* Headers */
    & h2 {
      font-family: var(--font-display);
      font-size: 1.875rem;
      font-weight: 400;
      color: var(--color-navy);
      margin-top: 2.5rem;
      margin-bottom: 1rem;
      line-height: 1.2;
      letter-spacing: -0.01em;
    }

    & h3 {
      font-family: var(--font-body);
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--color-charcoal);
      margin-top: 2rem;
      margin-bottom: 0.75rem;
      line-height: 1.3;
    }

    & h4 {
      font-family: var(--font-body);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-charcoal);
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }

    /* Paragraphs */
    & p {
      font-family: var(--font-body);
      font-size: 1.125rem;
      line-height: 1.8;
      color: var(--color-charcoal);
      margin-bottom: 1.5rem;
    }

    /* Links */
    & a {
      color: var(--color-carolina);
      text-decoration: none;
      border-bottom: 1px solid var(--color-carolina-light);
      transition: all var(--transition-base) ease;
    }

    & a:hover {
      color: var(--color-carolina-dark);
      border-bottom-color: var(--color-carolina-dark);
    }

    /* Lists */
    & ul, & ol {
      margin-bottom: 1.5rem;
      padding-left: 1.5rem;
    }

    & ul {
      list-style-type: disc;
    }

    & ol {
      list-style-type: decimal;
    }

    & li {
      margin-bottom: 0.5rem;
      line-height: 1.8;
    }

    & li::marker {
      color: var(--color-carolina);
    }

    /* Blockquotes */
    & blockquote {
      border-left: 3px solid var(--color-carolina);
      padding-left: 1.5rem;
      margin: 2rem 0;
      font-style: italic;
      color: var(--color-slate);
    }

    & blockquote p {
      margin-bottom: 0.5rem;
    }

    /* Code */
    & code {
      font-family: var(--font-mono);
      font-size: 0.9em;
      background-color: var(--color-cream);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      color: var(--color-charcoal);
    }

    & pre {
      background-color: var(--color-ink);
      color: var(--color-paper);
      padding: 1.5rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 2rem 0;
    }

    & pre code {
      background-color: transparent;
      padding: 0;
      color: inherit;
      font-size: 0.875rem;
      line-height: 1.6;
    }

    /* Images */
    & img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 2rem 0;
    }

    /* Tables */
    & table {
      width: 100%;
      border-collapse: collapse;
      margin: 2rem 0;
    }

    & th {
      background-color: var(--color-cream);
      color: var(--color-navy);
      font-weight: 600;
      padding: 0.75rem;
      text-align: left;
      border-bottom: 2px solid var(--color-stone);
    }

    & td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--color-stone);
    }

    & tr:hover {
      background-color: var(--color-paper);
    }

    /* Horizontal Rules */
    & hr {
      border: none;
      height: 1px;
      background: linear-gradient(
        to right,
        transparent,
        var(--color-stone) 20%,
        var(--color-stone) 80%,
        transparent
      );
      margin: 3rem 0;
    }

    /* Strong and Emphasis */
    & strong {
      font-weight: 600;
      color: var(--color-navy);
    }

    & em {
      font-style: italic;
    }

    /* First paragraph lead */
    & > p:first-of-type {
      font-size: 1.25rem;
      line-height: 1.7;
      color: var(--color-charcoal);
    }
  }

  /* Responsive Typography */
  @media (max-width: 768px) {
    .prose {
      & h2 {
        font-size: 1.5rem;
      }

      & h3 {
        font-size: 1.25rem;
      }

      & p, & li {
        font-size: 1rem;
      }

      & > p:first-of-type {
        font-size: 1.125rem;
      }
    }
  }
</style>
